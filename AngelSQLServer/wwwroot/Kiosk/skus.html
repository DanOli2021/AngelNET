<!DOCTYPE html>
<html>

<head>
    <title>POS - Inicio de sesión</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./bootstrap-5.3.0/css/bootstrap.min.css">


    <link rel="stylesheet" type="text/css" href="./css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="./css/responsive.dataTables.css">
    <script src="./js/code.jquery.com_jquery-3.7.0.min.js"></script>
    <script src="./js/jquery.dataTables.min.js"></script>
    <script src="./js/dataTables.responsive.min.js"></script>

    <script src="./js/scripts.js"></script>

    <script>
        const Token = sessionStorage.getItem("Token");

        if (Token == null) {
            window.location.href = "index.html";
        }

    </script>

</head>

<body>

    <div class="container">

        <div class="container-fluid">
            <nav class="navbar">
                <div class="container-fluid">
                    <a class="btn btn-primary btn-block" href="menu.html" style="width: 48%;">
                        <span style="float: left;">
                            <img src="images/icons/beta_general_back_128.png" alt="logo" style="width:24px">
                        </span>

                        Menu
                    </a>

                    <a class="btn btn-secondary btn-block" href="inventorymanagement.html" style="width: 48%;">
                        <span style="float: left;">
                            <img src="images/icons/beta_general_back_128.png" alt="logo" style="width:24px">
                        </span>

                        Inventory Management
                    </a>

                </div>
            </nav>
        </div>

        <div class="row justify-content-center">

            <div class="row">
                <a href="#">
                    <span style="float: left;">
                        <img src="images/icons/diamond_business_market_128.png" alt="logo" class="logo"
                            style="width: 94px; margin-right: 20px; margin-bottom: 20px;">
                    </span>
                    <h2>SKU (Stock Keeping Unit)</h2>
                </a>
            </div>

            <br />

            <div class="form-group">
                <input type="search" id="SearchSku" class="form-control" />
            </div>

            <div class="form-group">
                <div class="text-center">
                    <button type="button" id="ButtonSearch" class="btn btn-primary">
                        Search (F2)
                    </button>
                </div>
            </div>

            <br />

            <table id="dataTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Sku</th>
                        <th>Description</th>
                        <th>Price $</th>
                        <th>Clasification</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <script>

                var tabla;

                $(document).ready(function () {
                    var datos = [];

                    tabla = $('#dataTable').DataTable({
                        responsive: true,
                        data: datos,
                        bFilter: false,
                        columns: [
                            {
                                // Columna de botón
                                data: null,
                                render: function (data, type, row) {
                                    return '<button class="btn btn-primary">Plus</button>';
                                }
                            },
                            { data: 'id' },
                            { data: 'description' },
                            { data: 'price' },
                            { data: 'clasification' },
                        ]
                    });

                    $('#dataTable').on('click', 'td:first-child', function () {
                        var datosFila = tabla.row($(this).parents('tr')).data();
                        showSkuDialog(datosFila);
                        // Aquí se ejecuta el código al hacer doble clic en la columna de botón
                    });

                });
            </script>

        </div>


    </div>

    <dialog id="myDialog" class="dialog-box">
        <h1 id="dialogTittle">Title</h1>
        <p id="dialogMessage">Message</p>
        <button id="closeButton" onclick="closeDialog()">Cerrar</button>
    </dialog>

    <dialog id="skus_dialog" style="width: 90%;">

        <div class="row">
            <div class="col-md-12">

                <div class="form-group">
                    <label for="id">Sku</label>
                    <input type="text" class="form-control" id="id" name="id">
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" class="form-control" id="description" name="description">
                </div>

                <div class="form-group">
                    <label for="price">Price</label>
                    <input type="number" class="form-control" id="price" name="price">
                </div>

                <br />

                <div class="form-group">
                    <label for="image_name">Image</label>
                    <input type="text" class="form-control" id="image_name" name="image_name">
                </div>

                <div id="image_box" class="form-group">
                    <img id="image_element" src="" alt="Imagen">
                </div>


                <br />



                <button type="button" id="button_details" class="btn btn-primary"
                    onclick="toggleDiv()">Detalles</button>

                <br />

                <div id="sku_details">

                    <div class="form-group">
                        <label for="cost">Cost</label>
                        <input type="number" class="form-control" id="cost" name="cost">
                    </div>

                    <div class="form-group">
                        <label for="weight">Weight by Unit</label>
                        <input type="number" class="form-control" id="weight" name="weight">
                    </div>

                    <div class="form-group">
                        <label for="unit">Unit</label>
                        <input type="text" class="form-control" id="unit" name="unit">
                    </div>

                    <div class="form-group">
                        <label for="universal_id">Universal id</label>
                        <input type="text" class="form-control" id="universal_id" name="universal_id">
                    </div>

                    <div class="form-group">
                        <label for="consumption_tax">Consumption tax</label>
                        <input type="number" class="form-control" id="consumption_tax" name="consumption_tax">
                    </div>

                    <div class="form-group">
                        <label for="consumption_tax1">Consumption tax 2</label>
                        <input type="number" class="form-control" id="consumption_tax1" name="consumption_tax1">
                    </div>

                    <div class="form-group">
                        <label for="consumption_tax2">Consumption tax 3</label>
                        <input type="number" class="form-control" id="consumption_tax2" name="consumption_tax2">
                    </div>

                    <div class="form-group">
                        <label for="ClaveProdServ">ClaveProdServ (SAT)</label>
                        <input type="text" class="form-control" id="ClaveProdServ" name="ClaveProdServ">
                    </div>

                    <div class="form-group">
                        <label for="ClaveUnidad">ClaveUnidad (SAT)</label>
                        <input type="text" class="form-control" id="ClaveUnidad" name="ClaveUnidad">
                    </div>

                    <div class="form-group">
                        <label for="clasification">Clasification</label>
                        <select class="form-select" aria-label="Default select example" id="clasification"
                            name="clasification">
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="currency">Currency</label>
                        <select class="form-select" aria-label="Default select example" id="currency" name="currency">
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maker">Maker</label>
                        <select class="form-select" aria-label="Default select example" id="maker" name="maker">
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maker">Location</label>
                        <select class="form-select" aria-label="Default select example" id="location" name="location">
                        </select>
                    </div>


                    <br />

                    <div class="form-group">
                        <label for="requires_inventory">Requires Inventory</label>
                        <input type="checkbox" class="form-check-input" id="requires_inventory"
                            name="requires_inventory" style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="is_for_sale">Is for sale</label>
                        <input type="checkbox" class="form-check-input" id="is_for_sale" name="is_for_sale"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="is_for_sale">Bulk sale</label>
                        <input type="checkbox" class="form-check-input" id="bulk_sale" name="bulk_sale"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="require_series">Require series</label>
                        <input type="checkbox" class="form-check-input" id="require_series" name="require_series"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="require_lots">Require lots</label>
                        <input type="checkbox" class="form-check-input" id="require_lots" name="require_lots"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="kit">Is Kit</label>
                        <input type="checkbox" class="form-check-input" id="kit" name="kit"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="sell_below_cost">Sell below cost</label>
                        <input type="checkbox" class="form-check-input" id="sell_below_cost" name="sell_below_cost"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="locked">Locked</label>
                        <input type="checkbox" class="form-check-input" id="locked" name="locked"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>

                    <div class="form-group">
                        <label for="weight_request">Weight request</label>
                        <input type="checkbox" class="form-check-input" id="weight_request" name="weight_request"
                            style="top: 1.2rem; width: 5.0rem; height: 2.0rem;">
                    </div>



                </div>

                <br />
                <br />

                <button type="button" class="btn btn-primary" style="text-align: right;"
                    onclick="SaveSku()">Guardar</button>
                <button id="closeSkuEdit" class="btn btn-secondary" onclick="closeSkuDialog()"
                    style="text-align: right;">Cerrar</button>


            </div>
        </div>
    </dialog>

    <script>

        function showDialog(title, message) {

            document.getElementById('dialogTittle').innerText = title;
            document.getElementById('dialogMessage').innerText = '⚠️' + message;

            document.getElementById('myDialog').showModal();
        }

        function closeDialog() {
            document.getElementById('myDialog').close();
        }

        function showSkuDialog(sku_data) {

            var clasfications = sendToAngelPOST("kiosk/adminskus", "GetClasifications", Token, {});

            clasfications.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    console.log(responce_query.result);
                    return;
                }

                let clasifications = JSON.parse(responce_query.result);

                let select = document.getElementById('clasification');

                for (let i = 0; i < clasifications.length; i++) {
                    let option = document.createElement('option');
                    option.value = clasifications[i].id;
                    option.text = clasifications[i].description;
                    select.appendChild(option);
                }
            });

            var currencies = sendToAngelPOST("kiosk/adminskus", "GetCurrencies", Token, {});

            currencies.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    console.log(responce_query.result);
                    return;
                }

                let currencies = JSON.parse(responce_query.result);

                let select = document.getElementById('currency');

                for (let i = 0; i < currencies.length; i++) {
                    let option = document.createElement('option');
                    option.value = currencies[i].id;
                    option.text = currencies[i].description;
                    select.appendChild(option);
                }
            });

            var makers = sendToAngelPOST("kiosk/adminskus", "GetMakers", Token, {});

            makers.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    console.log(responce_query.result);
                    return;
                }

                let makers = JSON.parse(responce_query.result);

                let select = document.getElementById('maker');

                for (let i = 0; i < makers.length; i++) {
                    let option = document.createElement('option');
                    option.value = makers[i].id;
                    option.text = makers[i].description;
                    select.appendChild(option);
                }
            });

            var locations = sendToAngelPOST("kiosk/adminskus", "GetLocations", Token, {});

            locations.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    console.log(responce_query.result);
                    return;
                }

                let locations = JSON.parse(responce_query.result);

                let select = document.getElementById('location');

                for (let i = 0; i < locations.length; i++) {
                    let option = document.createElement('option');
                    option.value = locations[i].id;
                    option.text = locations[i].description;
                    select.appendChild(option);
                }
            });

            var data_result = sendToAngelPOST("kiosk/adminskus", "GetSku", Token, { id: sku_data.id });

            data_result.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    console.log(responce_query.result);
                    return;
                }

                let sku = JSON.parse(responce_query.result);

                var dialog = document.getElementById("skus_dialog");
                dialog.showModal();

                // Object.entries(sku).forEach(function ([clave, valor]) {
                //                     document.getElementById(clave).value = valor;
                //     });

                let id = document.getElementById('id');
                id.readOnly = true;

                let universal_id = document.getElementById('universal_id');
                universal_id.readOnly = true;

                document.getElementById('id').value = sku.id;
                document.getElementById('description').value = sku.description;
                document.getElementById('clasification').value = sku.clasification;
                document.getElementById('price').value = sku.price;
                document.getElementById('cost').value = sku.cost;
                document.getElementById('consumption_tax').value = sku.consumption_tax;
                document.getElementById('consumption_tax1').value = sku.consumption_tax1;
                document.getElementById('consumption_tax2').value = sku.consumption_tax2;
                document.getElementById('currency').value = sku.currency;
                document.getElementById('maker').value = sku.maker;
                document.getElementById('location').value = sku.location;
                document.getElementById('requires_inventory').checked = sku.requires_inventory;
                document.getElementById('is_for_sale').checked = sku.is_for_sale;
                document.getElementById('bulk_sale').checked = sku.bulk_sale;
                document.getElementById('require_series').checked = sku.require_series;
                document.getElementById('require_lots').checked = sku.require_lots;
                document.getElementById('kit').checked = sku.kit;
                document.getElementById('sell_below_cost').checked = sku.sell_below_cost;
                document.getElementById('locked').checked = sku.locked;
                document.getElementById('weight_request').checked = sku.weight_request;
                document.getElementById('weight').value = sku.weight;
                document.getElementById('unit').value = sku.unit;
                document.getElementById('ClaveProdServ').value = sku.ClaveProdServ;
                document.getElementById('ClaveUnidad').value = sku.ClaveUnidad;
                document.getElementById('universal_id').value = sku.universal_id;
                document.getElementById('image_name').value = sku.image_name;

                // Verifica si la URL es válida y si es una imagen
                if (isValidImageUrl(sku.image_name)) {
                    // Crea un elemento de imagen
                    var image = document.getElementById("image_element");

                    // Establece la URL de la imagen
                    image.src = sku.image_name;

                    // Agrega la imagen al elemento con el ID 'image_name'
                    document.getElementById('image_box').appendChild(image);
                }

                let description = document.getElementById('description');
                description.focus();

            });

        }

        function closeSkuDialog() {
            var dialog = document.getElementById("skus_dialog");
            dialog.close();
        }

        function toggleDiv() {
            var div = document.getElementById("sku_details");
            var button = document.getElementById("button_details");

            if (div.style.display === "none") {
                div.style.display = "block";
                button.innerText = "Hide Details";
            } else {
                div.style.display = "none";
                button.innerText = "Show Details";
            }

        }

        function SaveSku() {
            let sku = {};

            sku.id = document.getElementById('id').value;
            sku.description = document.getElementById('description').value;
            sku.clasification = document.getElementById('clasification').value;
            sku.price = parseFloat(document.getElementById('price').value);
            sku.cost = parseFloat(document.getElementById('cost').value);
            sku.consumption_tax = parseFloat(document.getElementById('consumption_tax').value);
            sku.consumption_tax1 = parseFloat(document.getElementById('consumption_tax1').value);
            sku.consumption_tax2 = parseFloat(document.getElementById('consumption_tax2').value);
            sku.currency = document.getElementById('currency').value;
            sku.maker = document.getElementById('maker').value;
            sku.location = document.getElementById('location').value;
            sku.requires_inventory = document.getElementById('requires_inventory').checked;
            sku.image_name = document.getElementById('image_name').value;
            sku.is_for_sale = document.getElementById('is_for_sale').checked;
            sku.bulk_sale = document.getElementById('bulk_sale').checked;
            sku.require_series = document.getElementById('require_series').checked;
            sku.require_lots = document.getElementById('require_lots').checked;
            sku.kit = document.getElementById('kit').checked;
            sku.sell_below_cost = document.getElementById('sell_below_cost').checked;
            sku.locked = document.getElementById('locked').checked;
            sku.weight_request = document.getElementById('weight_request').checked;
            sku.weight = parseFloat(document.getElementById('weight').value);
            sku.unit = document.getElementById('unit').value;
            sku.ClaveProdServ = document.getElementById('ClaveProdServ').value;
            sku.ClaveUnidad = document.getElementById('ClaveUnidad').value;

            var data_result = sendToAngelPOST("kiosk/adminskus", "UpsertSku", Token, sku);

            data_result.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    showDialog("Error:", responce_query.result);
                    console.log(responce_query.result);
                    return;
                }

                showDialog("Success:", "Sku Saved");

            });


        }


        toggleDiv();

    </script>

    <script>

        function isNullOrEmpty(str) {
            return !str || str.trim() === '';
        }

        function executeSearch() {

            var search_data = document.getElementById("SearchSku").value;

            if (isNullOrEmpty(search_data)) return;

            var datos = sendToAngelPOST("kiosk/adminskus", "SearchSkus", Token, { query: "skus_search = '" + document.getElementById("SearchSku").value + "'" });

            datos.then(function (query) {

                let responce_query = JSON.parse(query);

                if (responce_query.result.startsWith("Error:")) {
                    console.log(responce_query.result);
                    showDialog("Error:", responce_query.result);
                    return;
                }

                tabla.clear().rows.add(JSON.parse(responce_query.result)).draw(); // Borramos los datos antiguos, añadimos los nuevos y redibujamos la tabla
            });

        }

        var inputElement = document.getElementById('image_name');
        var imageElement = document.getElementById('image_element');

        // Agrega un evento 'input' al input de tipo texto
        inputElement.addEventListener('input', function () {
            var imageUrl = inputElement.value.trim();

            // Verifica si la URL es válida y si es una imagen
            if (isValidImageUrl(imageUrl)) {
                // Actualiza la propiedad 'src' de la imagen con la nueva URL
                imageElement.src = imageUrl;
                imageElement.style.display = 'inline'; // Muestra la imagen
            } else {
                imageElement.src = ''; // Vacía la URL de la imagen
                imageElement.style.display = 'none'; // Oculta la imagen
            }
        });

        $('#ButtonSearch').on('click', function () {
            executeSearch();
        });

        document.addEventListener('keydown', function (event) {
            // El identificador de tecla para F2 es "F2"
            if (event.key === "F2") {
                executeSearch();
            }
        });

        document.getElementById("SearchSku").focus();

    </script>

    <script src="./bootstrap-5.3.0/js/bootstrap.bundle.min.js"></script>

</body>

</html>